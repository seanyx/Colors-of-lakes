---
title: "Lake color analysis"
author: "Xiao Yang"
date: "1/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(tidyverse)
require(sf)
require(foreach)
```


## Jida's lake data three regions

```{r}
calc_hue_density = function(hue) {
  
  d = density(hue, n = 512)
  
  hue_density = tibble(hue = d$x, density = d$y) %>% 
    filter(hue >= 0, hue <= 1) %>% 
    mutate(rgb_color = hsv(h = hue, s = 1, v = 1))
  
  return(hue_density)
}
calc_hue_color_bar = function(n = 100) {
  return(tibble(hue = seq(0, 1, length = n)) %>% mutate(rgb_color = hsv(h = hue, s = 1, v = 1)))
}

## import the dataset

fileinfo = tibble(
  filedir = c(
    "data/mean_lake_color_roi1_8ba054ab336634e127d548f925681daf.csv",
    "data/mean_lake_color_roi2_dd85cb7c10dd310b1d3d1c93de39514c.csv",
    "data/mean_lake_color_roi3_c4549c94182362691561ca5712438d23.csv"
  ),
  region = c(
    "Tibetan Plateau",
    "Minnesota + Wisconsin",
    "Mackenzie Delta"
  ))

dat = foreach(i = 1:nrow(fileinfo), .combine = "bind_rows") %do% {
  read_csv(file = fileinfo$filedir[i]) %>% 
    mutate(region = fileinfo$region[i])
} %>% 
    select(-`.geo`) %>% 
    rename(img_id = `system:index`)

## need to handle the different date string position in the image ID

dat = dat %>% 
  filter(cloudAndShadow == 0,
         snowAndIce == 0,
         Red >= 0,
         Red <= 10000,
         Green >= 0,
         Green <= 10000,
         Blue >= 0,
         Blue <= 10000,
         !is.na(hue)) %>% 
  mutate(img_id_rev = stringi::stri_reverse(img_id)) %>% 
  separate(col = img_id_rev, into = c(NA, NA, NA, "satellite"), sep = "_") %>% 
  mutate(satellite = paste0("Landsat ", substr(satellite, start = 1, stop = 1))) %>% 
  select(
    -BQA,
    -cloudAndShadow,
    -snowAndIce,
    -uBlue
  )

lake_id = dat %>% 
  select(clon, clat) %>% 
  distinct()

lake_id = lake_id %>% 
  mutate(lake_id = 1:nrow(.))

dat = dat %>% 
  left_join(lake_id, by = c("clon", "clat"))

save(dat, file = "outputs/lake_color_three_regions_20200205.RData")

load("outputs/lake_color_three_regions_20200205.RData", verbose = T)


## range of values of hsv
dat %>% 
  gather(key = hsv, value = "value", c(hue, saturation, value)) %>% 
  select(hsv, value) %>% 
  ggplot() +
  geom_density(aes(value, fill = hsv), alpha = 0.3)

# remove lakes with high brightness value and low saturation
dat = dat %>%
  filter(saturation >= 0.125,
         value <= 0.125)

dat %>% 
  select(region, lake_id) %>% 
  distinct() %>% 
  group_by(region) %>% 
  count() %>% 
  ungroup


## regional distribution

hue_density_region = dat %>% 
  mutate(month = factor(month(date), levels = 1:12, labels = month.abb)) %>% 
  group_by(region) %>% 
  do({
    calc_hue_density(.$hue)
  }) %>% 
  ungroup
  
all_lake_color_region = hue_density_region %>% 
  ggplot(aes(hue, density)) + 
  geom_segment(aes(xend = hue, yend = 0, color = rgb_color), alpha = 0.7) + 
  geom_line(lwd = 1) + 
  scale_color_identity() +
  scale_x_continuous(limits = c(0, 1)) +
  labs(
    x = "Hue"
  ) +
  theme(
    panel.background = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  facet_wrap(~region, ncol = 1)

all_lake_color_region

all_lake_color_region %>% 
  ggsave(filename = "figures/all_lake_color_three_regions_20200205.png",
         width = 6,
         height = 6,
         dpi = 300)


## monthly breakdown

hue_density = dat %>% 
  mutate(month = factor(month(date), levels = 1:12, labels = month.abb)) %>% 
  group_by(region, month) %>% 
  do({
    calc_hue_density(.$hue)
  }) %>% 
  ungroup
  
all_lake_color = hue_density %>% 
  ggplot(aes(hue, density)) + 
  geom_segment(aes(xend = hue, yend = 0, color = rgb_color), alpha = 0.7) + 
  geom_line(lwd = 1) + 
  scale_color_identity() +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
  labs(
    y = "Density"
  ) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  facet_grid(month~region, scales = "free_y")

all_lake_color

all_lake_color %>% 
  ggsave(filename = "figures/all_lake_color_three_regions_monthly_20200205.png",
         width = 6,
         height = 7,
         dpi = 300)


## per lake density plot

hue_density_lake = dat %>% 
  right_join(dat %>% 
              group_by(lake_id) %>% 
              summarise(n = n()) %>% 
              ungroup() %>% 
              filter(n >= 30), by = "lake_id") %>% 
  group_by(lake_id) %>% 
  do({
    dat_temp = .
    calc_hue_density(dat_temp$hue) %>% 
      mutate(n = nrow(dat_temp)) %>% 
      mutate(region = dat_temp$region[1],
             clon = dat_temp$clon[1],
             clat = dat_temp$clat[1])
  }) %>% 
  ungroup()

yshift = hue_density_lake %>% 
  group_by(lake_id) %>% 
  summarize(ymax = max(density),
            region = first(region)) %>% 
  arrange(ymax) %>% 
  ungroup() %>% 
  group_by(region) %>% 
  mutate(yshift = 1:n()) %>% 
  ungroup()
  

hue_density_lake = hue_density_lake %>% 
  left_join(yshift, by = c("lake_id", "region"))

yscale = hue_density_lake %>% group_by(lake_id, region) %>% summarize(stats = median(density)) %>% ungroup() %>% 
  group_by(region) %>% 
  summarise(scale = quantile(stats, probs = 0.3)) %>% 
  ungroup

hue_density_lake = hue_density_lake %>% 
  left_join(yscale, by = "region")

lake_color_per_lake = hue_density_lake %>% 
  ggplot(aes(hue, density + yshift * scale)) + 
  # geom_segment(data = calc_hue_color_bar(n = 512), aes(x = hue, y = 0, xend = hue, yend = hue_density_lake$density %>% max * 0.02, color = rgb_color), alpha = 1) +
  # geom_line(aes(group = Hylak_id), alpha = 0.1) +
  geom_segment(aes(xend = hue, yend = yshift * scale, color = rgb_color, group = lake_id), alpha = 0.1) + 
  scale_color_identity() +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
  labs(
    y = "Density"
  ) +
  theme(
    panel.background = element_rect(color = "black", fill = "black"),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  facet_wrap(~region, nrow = 1)

lake_color_per_lake

lake_color_per_lake %>% 
  ggsave(filename = "figures/three_regions_lake_color_per_lake_20200205.png",
         width = 15,
         height = 6,
         dpi = 100)

## map mode color
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

color_mode = hue_density_lake %>% 
  group_by(lake_id, region) %>% 
  summarise(hue_mode = hue[which.max(density)],
            clon = first(clon),
            clat = first(clat)) %>% 
  ungroup() %>% 
  mutate(rgb_color = hsv(h = hue_mode, s = 1, v = 1))

color_mode_sf = color_mode %>% 
  st_as_sf(coords = c("clon", "clat"), crs = 4326)

mapview::mapview(color_mode_sf, zcol = "hue_mode", color = hsv(h = seq(0.1311, 0.4514, length = 100), s = 1, v = 1), fill = NA)
```


## seasonality

```{r}
require(lubridate)

doy_hue = dat %>% 
  mutate(doy = yday(date)) %>% 
  group_by(lake_id, doy) %>% 
  summarise(mean_hue = mean(hue),
            mean_sat = mean(saturation),
            region = first(region),
            date = first(date)) %>% 
  ungroup()

lake_color_seasonality = doy_hue %>% 
  mutate(plotcolor = hsv(h = mean_hue, s = mean_sat, v = 0.7)) %>% 
  ggplot() +
  geom_point(aes(x = doy, y = mean_hue, group = lake_id, color = plotcolor), alpha = 0.7, size = 0.05) +
  labs(x = "Day of the year",
       y = "Hue") +
  ylim(0, 0.75) +
  scale_color_identity() +
  facet_wrap(~region) +
  theme(
    # panel.background = element_rect(color = "black", fill = "black"),
    # panel.grid = element_blank(),
    # axis.title.y = element_blank(),
    # axis.text.y = element_blank(),
    # axis.ticks.y = element_blank()
  )

lake_color_seasonality

lake_color_seasonality %>% 
  ggsave(
    filename = "figures/lake_color_seasonality_filtered_20200205.png",
    width = 7,
    height = 3,
    dpi = 300
  )

## color index

doy_hue_index = doy_hue %>% 
  mutate(greenness = abs(mean_hue - 0.3),
         blueness = abs(mean_hue - 0.6),
         brownness = abs(mean_hue - 0.1))

greenness_mw = doy_hue_index %>% 
  filter(region == "Minnesota + Wisconsin") %>% 
  ggplot() +
  geom_smooth(aes(x = doy, y = greenness, group = lake_id), lwd = 0.1, se = F, show.legend = F, color = "darkgreen") +
  geom_point(aes(doy, y = greenness), size = 0.1, alpha = 0.1) + 
  geom_smooth(aes(x = doy, y = greenness), color = "green") +
  scale_y_reverse(minor_breaks = NULL, breaks = c(0.025, 0.275), labels = c("More green", "Less green"), lim = c(0.3, 0)) +
  labs(x = "Day of the year",
       y = "Greenness (hue ref: 0.3)",
       title = "Greenness for lakes from Minnesota + Wisconsin") +
  theme(axis.text.y.left = element_text(angle = 90, hjust = 0.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())

greenness_mw

greenness_mw %>% ggsave(
  filename = "figures/mw_greenness_20200205.png",
  width = 8,
  height = 5,
  dpi = 300
)

brownness_mk = doy_hue_index %>% 
  filter(region == "Mackenzie Delta") %>% 
  ggplot() +
  geom_smooth(aes(x = doy, y = brownness, group = lake_id), lwd = 0.1, se = F, show.legend = F, color = "brown") +
  geom_point(aes(doy, y = brownness), size = 0.1, alpha = 0.2) + 
  geom_smooth(aes(x = doy, y = brownness), color = "yellow") +
  scale_y_reverse(minor_breaks = NULL, breaks = c(0.025, 0.475), labels = c("More brown", "Less brown")) +
  labs(x = "Day of the year",
       y = "Brownness (ref hue: 0.1)",
       title = "Brownness for lakes from Mackenzie Delta") +
  theme(axis.text.y.left = element_text(angle = 90, hjust = 0.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())

brownness_mk

brownness_mk %>% ggsave(
  filename = "figures/mk_brownness_20200205.png",
  width = 8,
  height = 5,
  dpi = 300
)

doy_hue_index %>% 
  filter(region == "Tibetan Plateau") %>% 
  ggplot() +
  geom_smooth(aes(x = doy, y = blueness, group = lake_id), lwd = 0.1, se = F, show.legend = F, color = "darkblue") +
  geom_point(aes(doy, y = blueness), size = 0.1, alpha = 0.3) + 
  geom_smooth(aes(x = doy, y = blueness), color = "blue") +
  # ylim(0, 0.3) +
  labs(x = "Day of the year",
       y = "Blueness")
```

## time series

```{r}
set.seed(2020)
sublakes = dat %>% 
  select(lake_id, region) %>% 
  distinct() %>% 
  group_by(region) %>% 
  sample_n(100) %>% 
  ungroup()

sublakes %>%
  left_join(dat, by = c("lake_id", "region")) %>% 
  filter(date >= "2013-01-01") %>% 
  mutate(plot_color = hsv(h = hue, s = 1, v = 1)) %>% 
  ggplot(aes(x = date, y = hue, color = plot_color)) +
  geom_line(aes(group = lake_id), lwd = 0.1, color = "black", alpha = 0.4) +
  geom_point(size = 0.2) +
  scale_color_identity() +
  facet_wrap(~region, ncol = 1)
```

## temporal changes

```{r}
doy_hue_index = doy_hue %>% 
  mutate(greenness = abs(mean_hue - 0.3),
         blueness = abs(mean_hue - 0.6),
         brownness = abs(mean_hue - 0.1))

## running window tibble
window_size = 8
increment = 5

start_dates = seq(1984, 2020, by = increment)
end_dates = start_dates + window_size

start_dates = as.Date(paste0(start_dates, "-01-01"))
end_dates = as.Date(paste0(end_dates, "-01-01"))

windowed = tibble(start_dates, end_dates) %>% 
  filter(end_dates <= as.Date("2020-01-01")) %>% 
  mutate(label = paste0(year(start_dates), "-", year(end_dates) - 1)) %>% 
  mutate(mean_year = floor((year(start_dates) + year(end_dates)) / 2)) %>% 
  group_by(label) %>% 
  do({
    dat = .
    doy_hue_index %>% 
      filter(date <= dat$end_dates[1], date >= dat$start_dates[1]) %>% 
      mutate(
        start_date = dat$start_dates[1],
        end_date = dat$end_dates[1], 
        mean_year = dat$mean_year[1])
  }) %>% 
  ungroup()


windowed %>% 
  ggplot() +
  geom_bar(aes(x = label, fill = region), position = "dodge") +
  theme(axis.text.x.bottom = element_text(angle = 45, hjust = 1))
# plot the data

greenness_mw = windowed %>% 
  filter(region == "Minnesota + Wisconsin") %>% 
  ggplot() +
  # geom_smooth(aes(x = doy, y = greenness, group = lake_id), lwd = 0.1, se = F, show.legend = F, color = "darkgreen") +
  # geom_point(aes(doy, y = greenness), size = 0.1, alpha = 0.1) + 
  geom_smooth(aes(x = doy, y = greenness, color = mean_year, group = mean_year)) +
  scale_y_reverse(minor_breaks = NULL, breaks = c(0.025, 0.275), labels = c("More green", "Less green"), lim = c(0.3, 0)) +
  labs(x = "Day of the year",
       y = "Greenness (hue ref: 0.3)",
       title = "Greenness for lakes from Minnesota + Wisconsin",
       color = "Centered year") +
  theme(axis.text.y.left = element_text(angle = 90, hjust = 0.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_color_viridis_c()

greenness_mw

greenness_mw %>% ggsave(
  filename = "figures/mw_greenness_20200207_temporal.png",
  width = 8,
  height = 5,
  dpi = 300
)


brownness_mk = windowed %>% 
  filter(region == "Mackenzie Delta") %>% 
  ggplot() +
  # geom_smooth(aes(x = doy, y = greenness, group = lake_id), lwd = 0.1, se = F, show.legend = F, color = "darkgreen") +
  # geom_point(aes(doy, y = greenness), size = 0.1, alpha = 0.1) + 
  geom_smooth(aes(x = doy, y = brownness, color = mean_year, group = mean_year)) +
  scale_y_reverse(minor_breaks = NULL, breaks = c(0.025, 0.275), labels = c("More brown", "Less brown"), lim = c(0.3, 0)) +
  labs(x = "Day of the year",
       y = "Brownness (hue ref: 0.1)",
       title = "Brownness for lakes from Mackenzie Delta",
       color = "Centered year") +
  theme(axis.text.y.left = element_text(angle = 90, hjust = 0.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_color_viridis_c()

brownness_mk

brownness_mk %>% ggsave(
  filename = "figures/mk_brownness_20200205_temporal.png",
  width = 8,
  height = 5,
  dpi = 300
)




lake_id_sample = windowed %>% 
  filter(region == "Minnesota + Wisconsin") %>% 
  select(lake_id) %>% 
  distinct() %>% 
  sample_n(10)

windowed %>% 
  filter(region == "Minnesota + Wisconsin") %>% 
  right_join(lake_id_sample, by = "lake_id") %>% 
  ggplot() +
  geom_smooth(aes(x = doy, y = greenness, color = mean_year, group = mean_year), lwd = 0.3, se = F) +
  # geom_point(aes(doy, y = greenness), size = 0.1, alpha = 0.1) + 
  # geom_smooth(aes(x = doy, y = greenness, color = mean_year, group = mean_year)) +
  scale_y_reverse(minor_breaks = NULL, breaks = c(0.025, 0.275), labels = c("More green", "Less green"), lim = c(0.3, 0)) +
  labs(x = "Day of the year",
       y = "Greenness (hue ref: 0.3)",
       title = "Greenness for lakes from Minnesota + Wisconsin",
       color = "Centered year") +
  theme(axis.text.y.left = element_text(angle = 90, hjust = 0.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_color_viridis_c() +
  facet_wrap(~lake_id)
```



## time series spectral analysis

```{r}
require(spectral)

this_lake = dat %>% 
  filter(region == "Minnesota + Wisconsin",
         lake_id == 110) %>% 
  mutate(t = as.integer(date - as.Date("1983-01-01")) / 365.25)

ymean = mean(this_lake$hue)

this_lake = this_lake %>% 
  mutate(y = hue - ymean)

this_lake %>% ggplot() + geom_point(aes(yday(date), hue))
this_lake %>% ggplot() + geom_line(aes(t, hue), color = "grey") + geom_point(aes(t, hue))

periodogram = spec.lomb(x = this_lake$t, y = this_lake$y, ofac = 20, mode = "generalized")

plot(periodogram)

# select a frequency range
m = c(0.02, 4)
# select and reconstruct the most significant component
l2 = filter.lomb(periodogram, newx = seq(0, 35.5, length = 1000), filt = m, threshold = 6)

plot(this_lake$t, this_lake$y, type = "p")
lines(this_lake$t, this_lake$y)
lines(l2$x, l2$y, col = "red")
```


<!-- ## hydrolakes -->

<!-- ```{r} -->
<!-- dat = read_csv(file = "data/lake_color_f247c809ee74fd2458b96420f42f876d.csv") %>%  -->
<!--   select(-`.geo`) %>%  -->
<!--   rename(img_id = `system:index`) -->

<!-- dat = dat %>%  -->
<!--   mutate(date = as.Date(substr(img_id, start = 15, stop = 22), format = "%Y%m%d")) %>%  -->
<!--   filter(cloudAndShadow == 0, -->
<!--          snowAndIce == 0) %>%  -->
<!--   select( -->
<!--     clon, -->
<!--     clat, -->
<!--     img_id, -->
<!--     Hylak_id, -->
<!--     date, -->
<!--     hue, -->
<!--     saturation, -->
<!--     value -->
<!--   ) -->

<!-- dat %>%  -->
<!--   ggplot() + -->
<!--   geom_density(aes(hue, color = Hylak_id)) -->

<!-- calc_hue_density = function(hue) { -->

<!--   d = density(hue, n = 512) -->

<!--   hue_density = tibble(hue = d$x, density = d$y) %>%  -->
<!--     filter(hue >= 0, hue <= 1) %>%  -->
<!--     mutate(rgb_color = hsv(h = hue, s = 1, v = 1)) -->

<!--   return(hue_density) -->
<!-- } -->
<!-- calc_hue_color_bar = function(n = 100) { -->
<!--   return(tibble(hue = seq(0, 1, length = n)) %>% mutate(rgb_color = hsv(h = hue, s = 1, v = 1))) -->
<!-- } -->

<!-- hue_density = calc_hue_density(dat$hue) -->


<!-- MN_lake_color = hue_density %>%  -->
<!--   ggplot(aes(hue, density)) +  -->
<!--   geom_segment(aes(xend = hue, yend = 0, color = rgb_color), alpha = 0.7) +  -->
<!--   geom_line(lwd = 1) +  -->
<!--   scale_color_identity() + -->
<!--   scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) + -->
<!--   labs( -->
<!--     y = "Density" -->
<!--   ) + -->
<!--   theme( -->
<!--     panel.background = element_blank(), -->
<!--     axis.title = element_blank(), -->
<!--     axis.text = element_blank(), -->
<!--     axis.ticks = element_blank() -->
<!--   ) -->

<!-- MN_lake_color -->


<!-- ## per lake density plot -->

<!-- hue_density_lake = dat %>%  -->
<!--   group_by(Hylak_id) %>%  -->
<!--   do({ -->
<!--     calc_hue_density(.$hue) %>%  -->
<!--       mutate(n = nrow(.)) -->
<!--   }) %>%  -->
<!--   ungroup() -->

<!-- yshift = hue_density_lake %>%  -->
<!--   group_by(Hylak_id) %>%  -->
<!--   summarize(ymax = max(density)) %>%  -->
<!--   ungroup() %>%  -->
<!--   arrange(ymax) %>%  -->
<!--   select(Hylak_id) %>% -->
<!--   mutate(yshift = 1:nrow(.)) -->

<!-- hue_density_lake = hue_density_lake %>%  -->
<!--   left_join(yshift, by = "Hylak_id") -->

<!-- yscale = hue_density_lake %>% group_by(Hylak_id) %>% summarize(stats = median(density)) %>% ungroup() %>% pull(stats) %>% quantile(probs = 0.1) -->

<!-- MN_lake_color_per_lake = hue_density_lake %>%  -->
<!--   ggplot(aes(hue, density + yshift * yscale)) +  -->
<!--   # geom_segment(data = calc_hue_color_bar(n = 512), aes(x = hue, y = 0, xend = hue, yend = hue_density_lake$density %>% max * 0.02, color = rgb_color), alpha = 1) + -->
<!--   # geom_line(aes(group = Hylak_id), alpha = 0.1) + -->
<!--   geom_segment(aes(xend = hue, yend = yshift * yscale, color = rgb_color, group = Hylak_id), alpha = 0.1) +  -->
<!--   scale_color_identity() + -->
<!--   scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) + -->
<!--   labs( -->
<!--     y = "Density" -->
<!--   ) + -->
<!--   theme( -->
<!--     panel.background = element_rect(color = "black", fill = "black"), -->
<!--     panel.grid = element_blank(), -->
<!--     axis.title = element_blank(), -->
<!--     axis.text = element_blank(), -->
<!--     axis.ticks = element_blank() -->
<!--   ) -->

<!-- MN_lake_color_per_lake -->

<!-- MN_lake_color_per_lake %>%  -->
<!--   ggsave(filename = "figures/MN_lake_color_per_lake.png", -->
<!--          width = 8, -->
<!--          height = 6, -->
<!--          dpi = 100) -->
<!-- ``` -->