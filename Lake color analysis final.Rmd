---
title: "Lake color analysis"
author: "Xiao Yang"
date: "02/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(sf)
require(tidyverse)
source("functions.R")
```

## Import data

```{r}
datDir = dir("~/Google_Drive_morphologee1/Colors of lakes", full.names = T)

## raw data
dat_meta = datDir %>% 
  map(function(x) {
    y = read_csv(x)
    yfil = y %>% select(id, LANDSAT_ID, dwLehmann) %>% na.omit()
    return(yfil)}) %>% 
  reduce(rbind)

distinctObs = dat_meta %>% filter(!is.na(dwLehmann)) %>% distinct
distinctObs %>% nrow()
distinctObs %>% select(id) %>% distinct %>% nrow()
distinctObs %>% select(LANDSAT_ID) %>% distinct() %>% nrow()

## data cleaning
dat = datDir %>% 
  map(read_csv) %>% 
  reduce(rbind)

datFil = dat %>% 
  filter(fmask_cloud == 0, ## remove color estimates affected by cloud/cloud shadow
         fmask_snowIce == 0, ## remove color estimates affected by snow/ice
         Red >= 0, Red <= 1, ## remove color estimates with invalid reflectance values
         Green >= 0, Green <= 1, ## remove color estimates with invalid reflectance values
         Blue >= 0, Blue <= 1, ## remove color estimates with invalid reflectance values
         uBlue >= 0, uBlue <= 1, ## remove color estimates with invalid reflectance values
         dsweNone0 <= 2 ## remove color estimates with low confidence water classification define by DSWE
         ) %>%
  select(id, uBlue, Blue, Green, Red, date, dw, dwLehmann, LANDSAT_ID, mean_2m_air_temperature)

datFil = datFil %>% 
  mutate(dwPost = chroma2(Red, Green, Blue), ## calculate dw with the mean reflectances with RGB
         dwLehmannPost = chromaLehmann(uBlue, Blue, Green, Red)$wl, ## calculate dw with the mean reflectances with RGB and uBlue
         s = chromaLehmann(uBlue, Blue, Green, Red)$s, ## calculate purity with the mean reflectances with RGB and uBlue
         sp = chromaLehmann(uBlue, Blue, Green, Red)$sp,
         brightness = sqrt((Red^2 + Green^2 + Blue^2) / 3))

datFil = datFil %>% filter(!is.na(dwLehmann)) %>% select(-dwPost, -dwLehmannPost, -dw, -sp) %>% distinct

save(datFil, file = "outputs/lake_color_per_img_c2d77db60e960bbcd721fb580fa05896.RData")

load("outputs/lake_color_per_img_c2d77db60e960bbcd721fb580fa05896.RData", verbose = T)
load("outputs/shallow_deep_lake_ids.RData", verbose = T)
print("how many non-null dwLehmann values from how many lakes after removing effects from cloud, cloud shadow and snow&ice?")

distinctObs = datFil %>% select(id, LANDSAT_ID, dwLehmann) %>% na.omit() %>% distinct
distinctObs %>% nrow() ## 5143442 color observations
distinctObs %>% select(id) %>% distinct %>% nrow() ## 147025 lakes
distinctObs %>% select(LANDSAT_ID) %>% distinct() %>% nrow() ## 287167 landsat 8 images
datFil$date %>% summary() ## from 2013-04-10 to 2020-07-07
remove(distinctObs)

## append no. of color obs for each lake
nobs = datFil %>% 
  group_by(id) %>% 
  count() %>% 
  ungroup()

nobs$n %>% summary() # min = 1, max = 400, mean = 35, median = 28

datFil = datFil %>% left_join(nobs, by = "id")

distinctObs = datFil %>% filter(n >= 20) %>% select(id, LANDSAT_ID, dwLehmann) %>% na.omit() %>% distinct
distinctObs %>% nrow() ## 4635798 color observations
distinctObs %>% select(id) %>% distinct %>% nrow() ## 109824 lakes
distinctObs %>% select(LANDSAT_ID) %>% distinct() %>% nrow() ## 282317 landsat 8 images
datFil %>% filter(n >= 20) %>% pull(n) %>% summary() # min = 20, max = 400, mean = 62, median = 44

## append indicator of bottom reflectance
load("outputs/shallow_deep_lake_ids.RData", verbose = T)
bf = deep_lake_ids %>% mutate(bottom_reflectance = F) %>%
  bind_rows(shallow_lake_ids %>% mutate(bottom_reflectance = T))

datFil = datFil %>% left_join(bf, by = "id")

distinctObs = datFil %>% filter(n >= 20, bottom_reflectance == F) %>% select(id, LANDSAT_ID, dwLehmann) %>% na.omit() %>% distinct
distinctObs %>% nrow() ## 3449815 color observations
distinctObs %>% select(id) %>% distinct %>% nrow() ## 85360 lakes
distinctObs %>% select(LANDSAT_ID) %>% distinct() %>% nrow() ## 239397 landsat 8 images
datFil %>% filter(n >= 20, bottom_reflectance == F) %>% pull(n) %>% summary() # min = 20, max = 336, mean = 58, median = 41

save(datFil, file = "outputs/lake_color_per_img_c2d77db60e960bbcd721fb580fa05896.RData")

## distribution of nobs

nobs_dist = datFil %>% ggplot() + geom_density(aes(n), fill = "grey") +
  labs(x = "No. of observation", y = "") + geom_vline(data = tibble(x = c(20, 40)), aes(xintercept = x), color = "red") 

nobs_dist %>% ggsave(filename = "figs/obs_count_distribution.png", width = 5, height = 4)

# Export for GEE app
dw_color = datFil %>% dplyr::select(id, dwLehmann, LANDSAT_ID, date, s, brightness,
                                    nobs = n, bottom_reflectance) %>% 
  na.omit() %>% 
  mutate(doy = lubridate::yday(date)) %>% 
  mutate(dwLehmann = as.integer(dwLehmann),
         brightness1000 = as.integer(brightness * 1000),
         s1000 = as.integer(s * 1000),
         doy = as.integer(doy),
         nobs = as.integer(nobs)) %>% 
  dplyr::select(-s, -brightness)

write_csv(dw_color, file = "outputs/raw_color_c2d77db60e960bbcd721fb580fa05896.csv")
remove(dw_color)
```

## Modal color

### Calculate modal color for each lake

```{r}
require(diptest)
load("outputs/lake_color_per_img_c2d77db60e960bbcd721fb580fa05896.RData", verbose = T)

dat0 = datFil %>% filter(n >= 20, bottom_reflectance == F) %>% select(id, dwLehmann)

datMode = dat0 %>% 
  group_by(id) %>% 
  do({
    dat = .
    dwValues = dat %>% pull(dwLehmann)
    dip = dwValues %>% dip.test()
    d = dwValues %>% density()
    mode = d$x[which.max(d$y)][1]
      
    dip[1:3] %>% as_tibble() %>% 
      mutate(mode = mode, bw = d$bw, 
             dwStd = sd(dwValues, na.rm = T),
             interQ = (quantile(dwValues, probs = 0.75) - quantile(dwValues, probs = 0.25)) %>% as.numeric())
  }) %>% 
  ungroup()

## determine unimodal lakes
datMode = datMode %>% 
  mutate(
    unimodal = factor(p.value >= 0.05, levels = c(T, F), labels = c("Unimodal", "Non-unimodal")),
    unimodalBonferroni = factor(p.value >= 0.05 / nrow(datMode), levels = c(T, F), labels = c("Unimodal", "Non-unimodal")) ## Bonferroni correction
    ) %>% 
  distinct()

datMode %>% dplyr::select(id) %>% distinct ## 85, 360 lakes that don't have bf effect and with n >= 20

save(datMode, file = "outputs/dat_just_modal_color_2022.RData") ## this data will be used for visualization of lake color distribution and mapping, further matching to add additional metadata will decrease the available lake count
write_csv(datMode, file = "outputs/datMode20_c2d77db60e960bbcd721fb580fa05896.csv")
save(datMode, file = "outputs/datMode20_c2d77db60e960bbcd721fb580fa05896.RData")
```

## Color distribution (figure 1)

```{r}
load("outputs/dat_just_modal_color_2022.RData", verbose = T)

## density plot

### label values
d = density(datMode$mode)
max_mode = tibble(x = d$x, y = d$y) %>% 
  mutate(grp = x < 529) %>% 
  group_by(grp) %>% 
  summarise(ymax = max(y),
            x = x[which(y == ymax)]) %>% 
  ungroup() %>% 
  rename(y = ymax) %>% 
  select(-grp)

min_mode = tibble(x = d$x, y = d$y) %>% 
  filter(x >= 495 & x <= 574) %>% 
  slice_min(order_by = y)

mode_to_label = bind_rows(max_mode, min_mode)

### ggplot density plot

dist_mod = datMode %>% ggplot() +
  geom_vline(data = mode_to_label, aes(xintercept = x), color = "darkgrey") +
  ggridges::stat_density_ridges(geom = "density_ridges_gradient", aes(x = mode, y = 0, fill = stat(x)), color = NA, show.legend = F, bandwidth = 3, scale = 1) +
  # geom_histogram(aes(x = mode, y = stat(density)), binwidth = 3, fill = NA, color = "grey40") +
  scale_fill_gradientn(limits = c(450, 600), colours = dw2FUI(450:600), na.value='#FFFFFF00') +
  scale_x_continuous(breaks = seq(470, 600, by = 10), limits = c(470, 600), sec.axis = dup_axis(name = NULL, breaks = mode_to_label$x, labels = paste(format(mode_to_label$x, digits = 2), "nm"))) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  labs(x = "Lake color (modal dominant wavelength: nm)",
       y = "Probability") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 0),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.background = element_blank())

dist_mod

dist_mod %>% ggsave(filename = "figs/dist_mod_FUI_color_large.png",
                    width = 5,
                    height = 3)

### ggplot density plot to be used as the inset to the global map

dist_mod_small = datMode %>% ggplot() +
  geom_vline(data = mode_to_label, aes(xintercept = x), color = "darkgrey") +
  ggridges::stat_density_ridges(geom = "density_ridges_gradient", aes(x = mode, y = 0, fill = stat(x)), color = NA, show.legend = F, bandwidth = 3, scale = 1) +
  scale_fill_gradientn(limits = c(450, 600), colours = dw2FUI(450:600), na.value='#FFFFFF00') +
  scale_x_continuous(breaks = seq(470, 600, by = 30), limits = c(470, 600), sec.axis = dup_axis(name = NULL, breaks = mode_to_label$x, labels = paste(format(mode_to_label$x, digits = 2)))) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), labels = scales::percent_format(accuracy = 1)) +
  labs(x = "",
       y = "") +
  theme_bw() +
  theme(
    plot.margin = unit(x = c(0, 0.05, 0, 0.05), units = "in"),
    text = element_text(size = 7),
    axis.text.x = element_text(angle = 0),
    axis.ticks.y = element_blank(),
    axis.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.background = element_blank())

dist_mod_small

dist_mod_small %>% ggsave(filename = "figs/dist_mod_FUI_color_small.png",
                    width = 2.5,
                    height = 1.25)



## proportion of blue lakes mode dw <= 526 (31.3% and N = 26738)
## proportion of non blue lakes mode dw > 526 (68.7% and N = 58622)
datMode %>% 
  transmute(color_grp = cut(mode, breaks = c(min(mode), 526, max(mode)), labels = c("Blue", "Non-blue"), include.lowest = T)) %>% 
  group_by(color_grp) %>% 
  summarise(n = n(),
            nper = n / nrow(datMode)) %>% 
  ungroup()
```

## Color distribution map (figure 2)

### function to generate grids
```{r}
grid_gen = function(gridsize_x = 3, gridsize_y = 2) {

  grid = st_make_grid(
    x = st_bbox(c(xmin = -180, xmax = 180, ymin = -60, ymax = 90), crs = st_crs(4326)),
    cellsize = c(gridsize_x, gridsize_y),
    what = "polygons"
  )
  
  grid = grid %>% st_as_sf() %>% 
    mutate(index = 1:length(grid))

  return(grid)
}
```

### calculate color stats for each grid
```{r}
require(sf)
load("outputs/dat_just_modal_color_2022.RData", verbose = T)
lake_coords = st_read("outputs/lakeSample_Dp.geojson") %>% 
  distinct(.keep_all = T)

datModeSf = datMode %>% left_join(lake_coords %>% select(id)) %>% st_as_sf

grids = grid_gen() %>% 
  rename(grid_index = index,
         geometry = x)

grid_color = grids %>% 
  st_join(datModeSf, left = F) %>% 
  st_drop_geometry() %>% 
  as_tibble()

## add lake area to calculate weighted median of color
lakeMetric = read_csv("data/lakeMetrics_022b85da71a43d98e7c2cea22c6c0c66.csv")
grid_color = grid_color %>% 
  left_join(lakeMetric %>% select(id, area = polygonArea), by = "id")

require(spatstat)

grid_color_stats_sf = grid_color %>% 
  group_by(grid_index) %>% 
  summarise(
    median_mode = median(mode),
    median_mode_wArea = weighted.median(x = mode, w = area, type = 2),
    sd_mode = sd(mode),
    median_dwStd = median(dwStd),
    sd_dwStd = sd(dwStd),
    nlakes = n(),
    median_nobs = median(nobs)
  ) %>% 
  ungroup() %>% 
  left_join(grids, by = "grid_index") %>% 
  st_as_sf

save(grid_color_stats_sf, file = "outputs/grid_color_stats_sf_06282022.RData")
write_sf(grid_color_stats_sf, dsn = "outputs/figure1_global_lake_color_map_data_06282022.shp")
```

### Figure 1. global distribution of lake color grids

```{r}
load("outputs/grid_color_stats_sf_06282022.RData", verbose = T)
grid_color_stats_sf = grid_color_stats_sf %>% st_centroid()

## percentage of grid cells having median color in blue (16.2%)
grid_color_stats_sf %>% st_drop_geometry() %>% transmute(blue_grid = median_mode <= 526) %>% summarise(blue_grid_ratio = sum(blue_grid) / n())

countries = st_as_sf(rnaturalearth::countries110) %>% filter(region_un != "Antarctica")
crs_string = "+proj=robin +lon_0=0 +datum=WGS84 +units=m +no_defs" ## Robinson PROJ WKT

global_dist_mode = ggplot() + 
  geom_sf(data = countries %>% st_transform(crs = crs_string), fill = "grey20", color = NA) +
  geom_sf(data = grid_color_stats_sf %>% filter(nlakes > 1) %>% st_transform(crs = crs_string), aes(color = median_mode, size = sd_mode), alpha = 0.8) + 
  geom_sf(data = grid_color_stats_sf %>% filter(nlakes == 1) %>% st_transform(crs = crs_string), aes(color = median_mode), alpha = 0.8, size = 0.8, pch = 1) + 
  coord_sf(crs = crs_string, expand = expansion(mult = c(0, 0), add = c(0, 0))) +
  scale_color_gradientn(limits = c(480, 588), colours = dw2FUI(480:588), na.value='#FFFFFF00',
                        guide = guide_colorbar(title.position = "top", title.hjust = 0)) +
  scale_size_area(max_size = 2,
                  guide = guide_legend(title.position = "top", title.hjust = 0)) +
  labs(color = "Median lake color (nm)", size = "Spatial color variability (nm)") +
  theme_dark() +
  theme(legend.position = "bottom",
        panel.border = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "grey100"))

global_dist_mode

global_dist_mode %>% ggsave(filename = "figs/fig2_global_dist_mode_Fui_color_lightcolor.png",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")

global_dist_mode %>% ggsave(filename = "figs/fig2_global_dist_mode_Fui_color_lightcolor.pdf",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")

## 85360 lakes for the map
```


### Figure 1. weighted median global distribution of lake color grids

```{r}
load("outputs/grid_color_stats_sf_06282022.RData", verbose = T)
grid_color_stats_sf = grid_color_stats_sf %>% st_centroid()

## percentage of grid cells having median color in blue (16.2%)
grid_color_stats_sf %>% st_drop_geometry() %>% transmute(blue_grid = median_mode <= 526) %>% summarise(blue_grid_ratio = sum(blue_grid) / n())

countries = st_as_sf(rnaturalearth::countries110) %>% filter(region_un != "Antarctica")
crs_string = "+proj=robin +lon_0=0 +datum=WGS84 +units=m +no_defs" ## Robinson PROJ WKT

global_dist_mode_wArea = ggplot() + 
  geom_sf(data = countries %>% st_transform(crs = crs_string), fill = "grey20", color = NA) +
  geom_sf(data = grid_color_stats_sf %>% filter(nlakes > 1) %>% st_transform(crs = crs_string), aes(color = median_mode_wArea, size = sd_mode), alpha = 0.8) + 
  geom_sf(data = grid_color_stats_sf %>% filter(nlakes == 1) %>% st_transform(crs = crs_string), aes(color = median_mode_wArea), alpha = 0.8, size = 0.8, pch = 1) + 
  coord_sf(crs = crs_string, expand = expansion(mult = c(0, 0), add = c(0, 0))) +
  scale_color_gradientn(limits = c(480, 588), colours = dw2FUI(480:588), na.value='#FFFFFF00',
                        guide = guide_colorbar(title.position = "top", title.hjust = 0)) +
  scale_size_area(max_size = 2,
                  guide = guide_legend(title.position = "top", title.hjust = 0)) +
  labs(color = "Median lake color (nm)", size = "Spatial color variability (nm)") +
  theme_dark() +
  theme(legend.position = "bottom",
        panel.border = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "grey100"))

global_dist_mode_wArea

global_dist_mode_wArea %>% ggsave(filename = "figs/fig2_global_dist_mode_wArea_Fui_color_lightcolor.png",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")

## 85360 lakes for the map
```

### Figure S1 data-availability-map

```{r}
countries = st_as_sf(rnaturalearth::countries110) %>% filter(region_un != "Antarctica")
crs_string = "+proj=robin +lon_0=0 +datum=WGS84 +units=m +no_defs" ## Robinson PROJ WKT
## figure S-data-availability-map
load("outputs/grid_color_stats_sf.RData", verbose = T)
grid_color_stats_sf = grid_color_stats_sf %>% st_centroid()

global_dist_nobs = ggplot() + 
  geom_sf(data = countries %>% st_transform(crs = crs_string), fill = "grey60", color = NA) +
  geom_sf(data = grid_color_stats_sf %>% st_transform(crs = crs_string), aes(color = median_nobs, size = nlakes), alpha = 0.8) + 
  coord_sf(crs = crs_string, expand = expansion(0, 0)) +
  scale_color_continuous(trans = "log10", type = "viridis", guide = guide_colorbar(title.position = "top")) +
  scale_size_area(max_size = 1.5, guide = guide_legend(title.position = "top")) +
  labs(color = "Median no. of color measurements per lake", size = "Lake count") +
  theme_dark() +
  theme(legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

global_dist_nobs

global_dist_nobs %>% ggsave(filename = "figs/FigureS1_global_dist_nobs.png",
                       width = 7,
                       height = 4)
```

## zoomed in map 

### showing spatial color variability (figure 3)

```{r}
getUTMProj = function(lon, lat) {
  # // see https://apollomapping.com/blog/gtm-finding-a-utm-zone-number-easily and
  # // https://sis.apache.org/faq.html
  utmCode = ceiling((lon + 180) / 6)
  if (lat >= 0) {
    # output = sprintf(fmt = "EPSG:326%2d", utmCode)
    # output = sprintf(fmt = "326%2d", utmCode) %>% as.integer()
    output = 32600 + utmCode
  } else if (lat < 0) {
    # output = sprintf(fmt = "EPSG:327%2d", utmCode)
    # output = sprintf(fmt = "327%2d", utmCode) %>% as.integer()
    output = 32700 + utmCode
  }
  return(output)
}

grid_color_mode %>% mapview::mapview(zcol = "median")
lakes = st_read("outputs/lake_samples_jida_05172020.shp")
dps = st_read("outputs/lakeSample_Dp.geojson")

ids = c(
  7587,
  7696, # 
  7695,
  7809,
  6269
  )

ids = c(7587, 7586)

grid_color_fil = grid_color %>% filter(index %in% ids)

coords_centroid = grid_color_fil %>% st_union() %>% st_centroid() %>% st_coordinates()
crs = getUTMProj(coords_centroid[1], coords_centroid[2])

grid_color_fil = grid_color_fil %>% 
  st_drop_geometry() %>% 
  as_tibble() %>% 
  select(mode, id)

grid_lakes =  grid_color_fil %>% 
  left_join(lakes %>% select(id) %>% as_tibble(), by = "id") %>% 
  st_as_sf %>% 
  st_transform(crs = crs)

grid_lake_dp = grid_color_fil %>% 
  left_join(dps %>% select(id) %>% as_tibble(), by = "id") %>% 
  st_as_sf %>% 
  st_transform(crs = crs)

mapview::mapview(grid_lakes) + mapview::mapview(grid_lake_dp, zcol = "mode")

bbox = grid_lake_dp %>% st_bbox() %>% st_as_sfc %>% densify() %>% st_transform(crs = crs)
coastline = rnaturalearthdata::coastline50 %>% st_as_sf %>% 
  densify() %>% 
  st_transform(crs = crs) %>% 
  st_intersection(bbox %>% st_buffer(10000))

zoomIn = ggplot() + 
  geom_sf(data = coastline, color = "grey90") +
  geom_sf(data = grid_lakes, aes(fill = mode), color = NA) +
  geom_sf(data = bbox, color = "red", fill = NA) +
  coord_sf(expand = expansion()) +
  scale_fill_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  theme_dark() +
  theme(
    legend.position = "bottom", 
    legend.direction = "horizontal", 
    text = element_text(size = 10),
    panel.background = element_rect(fill = "grey10")) +
  labs(fill = "Modal dominant wavelength (nm)")

zoomIn

zoomIn %>% ggsave(filename = paste("figs/zoomIn", paste(ids %>% format(digits = 1), collapse = "_"), ".png", sep = "_"),
                  width = 5,
                  height = 5)
```

### zoomed in map customized area R1

```{r}
require(raster)
require(tidyverse)
require(sf)
lakes = st_read("outputs/lake_samples_jida_05172020.shp")
load("outputs/modelInput_20210302.RData", verbose = T)

## remove shallow lakes
load("outputs/shallow_deep_lake_ids.RData", verbose = T)
modelInput = modelInput %>% inner_join(deep_lake_ids)

latrange = c(67, 67.5)
lonrange = c(-101, -100)

lake_color_fil = modelInput %>% 
  filter(lat >= latrange[1] & lat <= latrange[2],
         lon >= lonrange[1] & lon <= lonrange[2]) %>% 
  dplyr::select(id, mode) %>% 
  left_join(lakes %>% dplyr::select(id), by = "id") %>% 
  st_as_sf()

## add dem layer
# https://code.earthengine.google.com/c55fcf0d9848cda5bb2daad072abcea2
dem = raster("figs/figure3background_ba77763fe238593c6476db4f8b389a07.tif")

dem = dem %>% crop(x = ., y = extent(c(lonrange, latrange)))

# https://www.r-bloggers.com/2018/08/how-to-quickly-enrich-a-map-with-natural-and-anthropic-details/
dem.m = rasterToPoints(dem) %>% as.tibble() %>% 
  rename_with(.fn = function(x) {return(c("x", "y", "z"))})

dem.m %>% ggplot() + geom_raster(aes(x = x, y = y, fill = z)) +
  scale_fill_viridis_c() +
  coord_equal()

slope = terrain(dem, opt = 'slope')
aspect = terrain(dem, opt = 'aspect')
hillshade = hillShade(slope, aspect, 40, 270)

hill.m = rasterToPoints(hillshade) %>% as_tibble() %>% 
  rename_with(.fn = function(x) {return(c("x", "y", "z"))})

hill.m %>% 
  ggplot() + 
  geom_raster(aes(x = x, y = y, fill = z)) +
  scale_fill_gradientn(colors = grey.colors(n = 100)) +
  coord_equal()

# 1. crop image with latrange and lonrange
# 2. export as png
# 3. import as png to set as ggplot background

bk = ggplot(data = hill.m) +
  geom_raster(aes(x = x, y = y, fill = z), show.legend = F) +
  geom_sf(data = lake_color_fil, fill = NA, color = NA) +
  scale_fill_gradientn(colors = grey.colors(n = 100, end = 0.5)) +
  coord_sf(expand = FALSE, xlim = lonrange, ylim = latrange) +
  theme_void()

bk

bkgrop = ggplotGrob(bk)
bkpanel = gtable::gtable_filter(bkgrop, "panel")

fig3_dembk = lake_color_fil %>% 
  ggplot() +
  annotation_custom(bkpanel, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) +
  geom_sf(aes(fill = mode), color = NA, show.legend = F) +
  scale_fill_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  coord_sf(expand = FALSE, xlim = lonrange, ylim = latrange, clip = "on") +
  ggspatial::annotation_scale()

fig3_dembk

fig3_dembk %>% 
  ggsave(filename = "figs/fig3_dembk_r1_deep_lakes.png",
         width = 4,
         height = 6)
```

### zoomed in map customized area R2

```{r}
require(raster)
require(tidyverse)
require(sf)
lakes = st_read("outputs/lake_samples_jida_05172020.shp")
load("outputs/modelInput_20210302.RData", verbose = T)
latrange = c(73.1113, 73.3845)
lonrange = c(124.5641, 125.6297)

lake_color_fil = modelInput %>% 
  filter(lat >= latrange[1] & lat <= latrange[2],
         lon >= lonrange[1] & lon <= lonrange[2]) %>% 
  dplyr::select(id, mode) %>% 
  left_join(lakes %>% dplyr::select(id), by = "id") %>% 
  st_as_sf()

## add dem layer
# https://code.earthengine.google.com/c55fcf0d9848cda5bb2daad072abcea2
dem = raster("figs/figure3background_f7afa23f002c5756c27619c95c00613b.tif")

dem = dem %>% crop(x = ., y = extent(c(lonrange, latrange)))

# https://www.r-bloggers.com/2018/08/how-to-quickly-enrich-a-map-with-natural-and-anthropic-details/
dem.m = rasterToPoints(dem) %>% as.tibble() %>% 
  rename_with(.fn = function(x) {return(c("x", "y", "z"))})

dem.m %>% ggplot() + geom_raster(aes(x = x, y = y, fill = z)) +
  scale_fill_viridis_c() +
  coord_equal()

slope = terrain(dem, opt = 'slope')
aspect = terrain(dem, opt = 'aspect')
hillshade = hillShade(slope, aspect, 40, 270)

hill.m = rasterToPoints(hillshade) %>% as_tibble() %>% 
  rename_with(.fn = function(x) {return(c("x", "y", "z"))})

hill.m %>% 
  ggplot() + 
  geom_raster(aes(x = x, y = y, fill = z)) +
  scale_fill_gradientn(colors = grey.colors(n = 100)) +
  coord_equal()

# 1. crop image with latrange and lonrange
# 2. export as png
# 3. import as png to set as ggplot background

bk = ggplot(data = hill.m) +
  geom_raster(aes(x = x, y = y, fill = z), show.legend = F) +
  geom_sf(data = lake_color_fil, fill = NA, color = NA) +
  scale_fill_gradientn(colors = grey.colors(n = 100, end = 0.5)) +
  coord_sf(expand = FALSE, xlim = lonrange, ylim = latrange) +
  theme_void()

bk

bkgrop = ggplotGrob(bk)
bkpanel = gtable::gtable_filter(bkgrop, "panel")

fig3_dembk = lake_color_fil %>% 
  ggplot() +
  annotation_custom(bkpanel, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) +
  geom_sf(aes(fill = mode), color = NA, show.legend = F) +
  scale_fill_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  coord_sf(expand = FALSE, xlim = lonrange, ylim = latrange, clip = "on") +
  ggspatial::annotation_scale()

fig3_dembk

fig3_dembk %>% 
  ggsave(filename = "figs/fig3_dembk_r2.png",
         width = 4,
         height = 6)
```

## model color

### descriptive stats

```{r}
load("outputs/20220211_model_input.RData", verbose = T)

## of all warm lakes, what percentage is blue
model_input %>% mutate(temp_grp = summer_temperature_mean < 18.98) %>% 
  group_by(temp_grp) %>% 
  summarise(blue_ratio = sum(mode <= 526) / n()) %>% 
  ungroup()

## of all blue lakes, what percentage experience ice cover
model_input %>% mutate(color_grp = mode <= 526) %>% 
  group_by(color_grp) %>% 
  summarise(ice_cover_ratio = sum(winter_temperature_mean <= 0) / n()) %>% 
  ungroup()

## of ice covered lakes, what percentage is blue
model_input %>% mutate(ice_cover = winter_temperature_mean <= 0) %>% 
  group_by(ice_cover) %>% 
  summarise(blue_ratio = sum(mode <= 526) / n()) %>% 
  ungroup()
```

## tree model 

```{r}
require(rpart)
require(partykit)
require(tidyverse)
# load("outputs/20220211_model_input.RData", verbose = T)
load("outputs/20220619_model_input_depth_updated.RData", verbose = T)

nrow(model_input) ## 77501 lakes for modeling

model_input = model_input %>% 
  select(
    mode,
    dwStd,
    occ_mean,
    # class,
    winter_temperature_mean,
    summer_temperature_mean,
    total_precipitation_mean,
    spring_total_precipitation_mean,
    depth_mean,
    volumn,
    lake_area,
    dist_to_shore,
    elevation,
    total_precipitation_stdDev,
    mean_2m_air_temperature_stdDev
    )

model_input %>% 
  cor() %>% 
  corrplot::corrplot(.)

model_input = model_input %>% select(-dwStd)

model_input %>% names %>% paste(collapse = " + ")

fitted_raw = rpart(mode ~ ., data = model_input, control = rpart.control(cp = 0.01))

## model performance rmse, mae, and r2
model_input %>% 
  mutate(.pred = predict(fitted_raw, newdata = model_input),
         dif = .pred - mode) %>% 
  summarise(
    rmse = sqrt(mean(dif^2)),
    mae = mean(abs(dif)),
    r2 = 1 - (sum(dif^2)) / (sum((mode - mean(mode))^2))
  ) %>% 
  ungroup()

# # A tibble: 1 × 3
#    rmse   mae    r2
#   <dbl> <dbl> <dbl>
# 1  31.2  26.2 0.196

fitted = as.party.rpart(obj = fitted_raw) ## convert to party object

plot(fitted)

terminal_node_ids = nodeids(fitted, terminal = T)

## attached the leaf node id to each obs
lake_coords = st_read("outputs/lakeSample_Dp.geojson") %>% 
  distinct(.keep_all = T) %>% 
  select(id)

lake_latlon = lake_coords %>% select(id) %>% mutate(
  lon = st_coordinates(geometry)[, 1],
  lat = st_coordinates(geometry)[, 2]
) %>% st_drop_geometry() %>% 
  as_tibble()

load("outputs/20220211_model_input.RData", verbose = T)

model_input = model_input %>% left_join(lake_latlon, by = "id")
for (i in terminal_node_ids) {
  temp = fitted[i]$data %>% as_tibble %>% 
    left_join(model_input %>% select(lon, lat, elevation, mode, winter_temperature_mean, summer_temperature_mean, depth_mean)) %>% 
    mutate(id = i)
  if(i == terminal_node_ids[1]) {
    pred = temp
  } else if (i != terminal_node_ids[1]) {
    pred = bind_rows(pred, temp)
  }
}

pred %>% count(id) ## no. of leaf nodes

node_blue_ratio = pred %>% group_by(id) %>% 
  summarise(blue_ratio = sum(mode <= 526) / n()) %>% 
  ungroup() %>% 
  arrange(desc(blue_ratio))

node_blue_ratio

## leaf node maps

terminal_node_ids
nodeName = tibble(node_id = terminal_node_ids,
       node_name = c("wetter and cooler ",
                     "wetter and warmer",
                     "drier, higher elev., deeper",
                     "drier, higher elev., shallower",
                     "drier, lower elevation")) %>% 
  mutate(order = 1:length(terminal_node_ids))

pred_sf = pred %>% st_as_sf(coords = c("lon", "lat"), crs = 4326)
world_sf = st_as_sf(rnaturalearthdata::coastline110)

strip_text = pred %>% 
  left_join(nodeName, by = c("id" = "node_id")) %>% 
  group_by(id) %>% 
  summarise(
    nlakes = n(),
    nperlakes = nlakes / nrow(pred) * 100,
    id_text = paste0(node_name, ": (", format(nperlakes, digits = 3), "%)"),
    order = first(order)) %>% 
  ungroup() %>% 
  distinct() %>% 
  mutate(id_text = fct_reorder(id_text, order))

node_maps = pred_sf %>% 
  left_join(strip_text, by = "id") %>% 
  ggplot() +
  geom_sf(data = world_sf, color = "darkgrey", lwd = 0.2) +
  geom_sf(aes(color = mode), cex = 0.1, alpha = 0.3) +
  coord_sf(ylim = c(-60, 85)) +
  theme_bw() +
  scale_color_gradientn(limits = c(480, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00',
                        guide = guide_colorbar(title.position = "top", title.hjust = 0)) +
  labs(color = "Lake color (nm)") +
  facet_wrap(~id_text, ncol = 2) +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        panel.grid = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face = "bold"),
        panel.border = element_rect(color = "grey80"))

node_maps

node_maps %>% ggsave(filename = "figs/FigureS_node_maps_colored_dots_FUI_newName.png",
                     width = 6,
                     height = 5.5
                     )

node_maps %>% ggsave(filename = "figs/FigureS_node_maps_colored_dots_FUI_newName.pdf",
                     width = 6,
                     height = 5.5
                     )
```

## party tree

```{r}
require(ggparty)

terminal_node_ids = nodeids(fitted, terminal = T)

bw = 1.5
den_all = pred %>% pull(mode) %>% density(bw = bw)
color_fill_all = den_all[1:2] %>% as_tibble() %>% rename(mode = x, d = y) %>% 
  mutate(d = d * nrow(pred))

maxd = max(color_fill_all$d) / 2

color_fill = tibble(id = terminal_node_ids) %>% group_by(id) %>% 
  do({
    dat = .
    node_id = dat$id[1]
    this_pred = pred %>% filter(id == node_id)
    den = this_pred %>% pull(mode) %>% density(bw = bw)
    den[1:2] %>% as_tibble() %>% rename(mode = x, d = y) %>% 
      mutate(d = d * nrow(this_pred))
  }) %>% 
  ungroup()

ggparty_tree = fitted %>% 
  ggparty(terminal_space = 0.4) +
  geom_edge(aes(lwd = nodesize)) +
  geom_edge_label(mapping = aes(label = paste(substr(breaks_label, start = 1, stop = 15)))) +
  geom_node_splitvar(color = "grey10", fill = "white", label.padding = unit(0.2, "lines"), angle = 90, fontface = "bold") +
  geom_node_info(
    aes(label = paste0("Node ", id)),
    fontface = "bold",
    ids = "terminal",
    size = 3,
    nudge_y = 0.01
    ) +
  geom_node_plot(gglist = list(
    geom_segment(data = color_fill, aes(x = -d, xend = d, y = mode, yend = mode, color = mode), lwd = 1, show.legend = FALSE),
    scale_x_continuous(limits = c(-maxd, maxd)),
    scale_y_continuous(limits = c(465, 595)),
    scale_color_gradientn(colors = dw2FUI(seq(min(color_fill$mode), max(color_fill$mode), by = 1))),
    theme_void(), 
    labs(
      x = NULL,
      y = NULL)
    ),
    shared_axis_labels = T) +
  theme(legend.position = "none",
        text = element_text(size = 10))

ggparty_tree

ggparty_tree %>% ggsave(
  filename = "figs/figure2_ggparty_tree_with_histogram.png",
  width = 6.5,
  height = 4.5
)

ggparty_tree %>% ggsave(
  filename = "figs/figure2_ggparty_tree_with_histogram.pdf",
  width = 6.5,
  height = 4.5
)

sw_temperature = model_input %>% ggplot(aes(x = summer_temperature_mean, y = winter_temperature_mean)) + geom_point(cex = 0.1, alpha = 0.2) +
  geom_smooth(method = "lm")

sw_temperature %>% ggsave(filename = "figs/figureS_s_w_temperature_relationship.png", height = 6, width = 6)

model_input %>% filter((summer_temperature_mean >= 18.44 - 1) & (summer_temperature_mean <= 18.44 + 1)) %>% 
  ggplot() + geom_histogram(aes(x = winter_temperature_mean))
```

## Figure 3

```{r}
load("outputs/20220211_model_input.RData", verbose = T)
model_input %>% ggplot() + geom_histogram(aes(depth_mean), color = "white") + scale_x_log10()
model_input %>% filter(depth_mean >= 20) %>% nrow() ## 646 lakes with mean depth ≥ 20 meter

climte_variable_grps = model_input %>%
  mutate(
    summer_temp_grp = base::cut(summer_temperature_mean, breaks = seq(-5, 40, by = 2), include.lowest = T, labels = as.character((-2:19) * 2)),
    `dw ≤ 526?` = cut(mode, breaks = c(min(mode), 526, max(mode)), labels = c("Blue", "Non-blue"), include.lowest = T),
    precip_grp = base::cut(total_precipitation_mean * 1000, breaks = c(0, 55, max(total_precipitation_mean * 1000)), labels = c("Lower precip ≤ 55 mm", "Higher precip > 55 mm"), include.lowest = T),
    depth_grp = base::cut(depth_mean, breaks = c(min(depth_mean), 3.64, max(depth_mean)), labels = c("≤3.6", ">3.6"), include.lowest = T))

climte_variable_blue_ratios = climte_variable_grps %>%
  group_by(summer_temp_grp, precip_grp, depth_grp) %>%
  summarise(blue_ratio = sum(mode <= 526) / n(),
            n = n()) %>%
  ungroup()

climate_depth_blue_lake_ratio = climte_variable_blue_ratios %>% 
  ggplot() +
  geom_point(aes(x = summer_temp_grp, y = blue_ratio, color = depth_grp, size = n), alpha = 0, cex = 3) +
  geom_line(aes(x = as.integer(summer_temp_grp), y = blue_ratio, color = depth_grp), lty = 1) +
  geom_point(aes(x = summer_temp_grp, y = blue_ratio, color = depth_grp, size = n), alpha = 0.8) +
  geom_vline(aes(xintercept = 12.5), color = "red") +
  labs(x = "Summer mean surface air temperature (ºC)",
       y = "Blue lake ratio",
       size = "Lake count",
       color = "Mean depth (m)") +
  scale_y_continuous(expand = expansion(c(0, 0.03), 0), labels = scales::percent_format()) +
  scale_size_area(guide = guide_legend(title.position = "top")) +
    scale_color_manual(values = grey(seq(0.1, 0.6, length = 2)) %>% rev(), guide = guide_legend(title.position = "top")) +
  facet_wrap(~precip_grp) +
  theme_bw() +
  theme(axis.text.x.bottom = element_text(angle = 45, hjust = 0, vjust = 0),
        legend.position = "bottom",
        legend.direction = "horizontal")

climate_depth_blue_lake_ratio

climate_depth_blue_lake_ratio %>% ggsave(filename = "figs/Figure3_summer_climate_depth_blue_lake_ratio_temp2bin.png", width = 6.5, height = 3.5)

climate_depth_blue_lake_ratio %>% ggsave(filename = "figs/Figure3_summer_climate_depth_blue_lake_ratio_temp2bin.pdf", width = 6.5, height = 3.5)
```


## supp figures

### lake count accouting via density curves
This is to compare the distribution of lake surface area from (1) the entire lake dataset (2) the 10% sample and the (3) lakes used for modeling

```{r}
## entire ucla dataset
layers = st_layers(dsn = "~/Downloads/UCLA_global_lakes_forXiao/Circa2015.gdb/")
lakes_all = st_read("~/Downloads/UCLA_global_lakes_forXiao/Circa2015.gdb", layer = "Circa2015", query = sprintf("SELECT OBJECTID, Shape_Area, Ave_Dpt, Src_Type FROM \"%s\"", layers$name[1]))
lakes_all = lakes_all %>% st_drop_geometry() %>% as_tibble()
save(lakes_all, file = "outputs/ucla_lakes_all.RData")

load("outputs/ucla_lakes_all.RData", verbose = T)

## 10% sample
lakeMetric = read_csv("data/lakeMetrics_022b85da71a43d98e7c2cea22c6c0c66.csv")
lakeMetric %>% nrow()

## actual lakes with estimated modal color
load("outputs/dat_just_modal_color_2022.RData", verbose = T)
nrow(datMode)


merged = lakes_all %>% select(Shape_Area) %>% 
  filter(Shape_Area >= 100000) %>% 
  mutate(source = "UCLA circa 2015 Lake Database") %>% 
  bind_rows(lakeMetric %>% transmute(Shape_Area = polygonArea) %>% mutate(source = "Lake sample")) %>% 
  bind_rows(datMode %>% select(id) %>% left_join(lakeMetric %>% select(id, polygonArea), by = "id") %>% transmute(Shape_Area = polygonArea) %>% mutate(source = "Lake modal color")) %>% 
  mutate(source = factor(x = source, levels = c("UCLA circa 2015 Lake Database", "Lake sample", "Lake modal color"), labels = c("UCLA circa 2015 Lake Database", "10% Lake sample", "Lakes with modal color"), ordered = T))

save(merged, file = "outputs/merged_lake_size.RData")

load("outputs/merged_lake_size.RData", verbose = T)

lakesize_distribution = merged %>% ggplot() +
  geom_histogram(aes(x = Shape_Area / 1000000, fill = source), bins = 50, color = "white") +
  scale_x_log10() +
  facet_wrap(~source, scales = "free_y", nrow = 3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(fill = "",
       y = "Count",
       x = "Lake area (km2)")

lakesize_distribution

lakesize_distribution %>% ggsave(filename = "figs/lakesize_distribution.png", width = 6, height = 6)
```


### calculate color stats for each grid

```{r}
load("outputs/shallow_deep_lake_ids.RData", verbose = T)
datMode = datMode %>% inner_join(deep_lake_ids)
lakeMeta = read_csv("outputs/lake_meta_v2.csv", col_types = "iccnnc")
lake_coords = st_read("outputs/lakeSample_Dp.geojson") %>% 
  distinct(.keep_all = T)

datDepth = datMode %>% left_join(lakeMeta %>% select(depthMean, id), by = "id") %>% 
  left_join(lake_coords %>% select(id, geometry), by = "id") %>% 
  st_as_sf()

grid_depth = grid_gen() %>% 
  st_join(datDepth, left = F) %>% 
  mutate(x = st_centroid(x))

grid_depth_stats_raw = grid_depth %>% 
  group_by(index) %>% 
  summarise(
    median_depth = median(depthMean),
    sd_depth = sd(depthMean),
    n = n(),
    median_nobs = median(nobs)
  ) %>% 
  ungroup()

save(grid_depth_stats_raw, file = "outputs/grid_depth_stats_raw_deep_lakes.RData")


countries = st_as_sf(rnaturalearth::countries110) %>% filter(region_un != "Antarctica")
crs_string = "+proj=robin +lon_0=0 +datum=WGS84 +units=m +no_defs" ## Robinson PROJ WKT

values = grid_depth_stats_raw$median_depth %>% quantile(probs = seq(0, 1, by = 0.05))
colors = viridis::cividis(n = length(values))

global_depth_dist = ggplot() + 
  geom_sf(data = countries %>% st_transform(crs = crs_string), fill = "grey40", color = NA) +
  geom_sf(data = grid_depth_stats_raw %>% filter(n > 1) %>% st_transform(crs = crs_string), aes(color = median_depth, size = sd_depth), alpha = 0.8) + 
  geom_sf(data = grid_depth_stats_raw %>% filter(n == 1) %>% st_transform(crs = crs_string), aes(color = median_depth), alpha = 0.8, size = 0.8, pch = 1) + 
  coord_sf(crs = crs_string, expand = expansion(0, 0)) +
  scale_color_continuous(trans = "log10", type = "viridis", guide = guide_colorbar(title.position = "top")) +
  scale_size_area(max_size = 2,
                  trans = "sqrt", 
                  guide = guide_legend(title.position = "top", title.hjust = 0)) +
  labs(color = "Median lake depth (meter)", size = "Spatial depth variability (meter)") +
  theme_dark() +
  theme(legend.position = "bottom",
        panel.border = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "grey10"))

global_depth_dist

global_depth_dist %>% ggsave(filename = "figs/global_depth_dist_deep_lakes.png",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")
```

### summer winter temperature relationship

```{r}
## summer vs winter SAT
swSAT_colorGrp = model_input %>% 
  mutate(blue = mode <= 526,
         blue = factor(blue, levels = c(T, F), labels = c("Blue", "Non-blue"))) %>% 
  ggplot(aes(x = summer_temperature_mean, y = winter_temperature_mean, color = mode)) +
  geom_point(size = 0.1, alpha = 0.5) +
  geom_vline(aes(xintercept = 19, lty = "x = 19.0ºC")) +
  labs(x = "Summer mean surface air temperature (ºC)",
        y = "Winter mean surface air temperature (ºC)",
        lty = "",
        color = "Lake color") +
  scale_color_gradientn(limits = c(480, 588), colours = dw2FUI(480:588), na.value='#FFFFFF00') +
  facet_wrap(~blue) +
  theme_bw()

swSAT_colorGrp

swSAT_colorGrp %>% ggsave(filename = "figs/summer_winter_SAT.pdf", width = 7, height = 4)

swSAT_colorGrp %>% ggsave(filename = "figs/summer_winter_SAT.png", width = 7, height = 4)

## summer vs winter temperature overall

lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

lm_eqn(model_input %>% transmute(x = summer_temperature_mean, y = winter_temperature_mean))

swfit = lm(winter_temperature_mean~summer_temperature_mean, data = model_input)

predict(swfit, newdata = tibble(summer_temperature_mean = 18.98), se.fit = T)
swfit %>% summary()
# y = -45.4 + 2.0 * x (r2 = 0.6)

summer_winter_temperature = model_input %>% 
  ggplot(aes(x = summer_temperature_mean, y = winter_temperature_mean)) +
  geom_point(size = 0.1, alpha = 0.3) +
  geom_smooth(method = "lm", aes(color = "Linear regression")) +
  # coord_equal() +
  labs(x = "Summer mean surface air temperature (ºC)",
       y = "Winter mean surface air temperature (ºC)",
       color = "") +
  theme_bw() +
  theme(legend.position = c(0.7, 0.1),
        legend.box.background = element_blank(),
        legend.background = element_blank())

summer_winter_temperature

summer_winter_temperature %>% 
  ggsave(filename = "figs/summer_winter_temperature_overall.pdf",
         width = 3.5,
         height = 4)

summer_winter_temperature %>% 
  ggsave(filename = "figs/summer_winter_temperature_overall.png",
         width = 3.5,
         height = 4)
  
```

### lake count vs spatial color variability

```{r}
## grid cell lake no. vs color variability
load("outputs/grid_color_stats_sf.RData", verbose = T)

color_std_scatter = grid_color_stats_sf %>% 
  st_drop_geometry() %>% 
  ggplot(aes(x = nlakes, y = sd_mode)) +
  geom_point(aes(color = median_mode), alpha = 0.6) +
  scale_color_gradientn(limits = c(480, 588), colours = dw2FUI(480:588), na.value='#FFFFFF00', guide = guide_colorbar(title.position = "top")) +
  scale_x_log10() +
  # geom_smooth(alpha = 0.7, method = "loess") +
  labs(
    x = "Lake count",
    y = "Color variability (nm)",
    color = "Median lake color (nm)"
  ) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")

color_std_scatter

color_std_scatter %>% ggsave(filename = "figs/color_std_lake_no_deep_lakes.png",
                             width = 7,
                             height = 4)

cor(grid_color_stats_sf$nlakes, grid_color_stats_sf$sd_mode, method = "pearson", use = "complete.obs")
```

### lakes susceptible to changing to non-blue color due to climate change 

```{r}
load("outputs/20220211_model_input.RData", verbose = T)

lake_coords = st_read("outputs/lakeSample_Dp.geojson") %>% 
  distinct(.keep_all = T)

slakes = model_input %>% 
  filter(total_precipitation_mean >= 0.055,
         summer_temperature_mean < 18.98,
         summer_temperature_mean > 15.98,
         mode <= 526) %>% 
  mutate(dif = summer_temperature_mean - 18.98,
         grp = cut(dif, breaks = c(-3, -2, -1, 0), labels = c("+3ºC", "+2ºC", "+1ºC"), include.lowest = T), ordered_result = T) %>% 
  select(id, grp, summer_temperature_mean, dif) %>% 
  na.omit() %>% 
  left_join(lake_coords, by = "id") %>% 
  st_as_sf()

countries = st_as_sf(rnaturalearth::countries110) %>% filter(region_un != "Antarctica")
crs_string = "+proj=robin +lon_0=0 +datum=WGS84 +units=m +no_defs" ## Robinson PROJ WKT

### 
nrow(slakes) # 3771 lakes at risk
slakes %>% st_drop_geometry() %>% as_tibble() %>% distinct %>% group_by(grp) %>% count() %>% ungroup()
# +3ºC   1907, +2ºC   1351, +1ºC    513
## grp       n
#   <fct> <int>
# 1 +3ºC   1907
# 2 +2ºC   1351
# 3 +1ºC    513

sus_lake_dist = ggplot() + 
  geom_sf(data = countries %>% st_transform(crs = crs_string), fill = "grey50", color = NA) +
  geom_sf(data = slakes %>% st_transform(crs = crs_string), aes(color = grp), alpha = 0.5, size = 0.5) + 
  coord_sf(crs = crs_string, expand = expansion(0, 0)) +
  scale_colour_viridis_d() +
  labs(color = "Blue lakes susciptible to change color to non-blue") +
  guides(color = guide_legend(override.aes = list(size = 1))) +
  theme_dark() +
  theme(legend.position = "bottom",
        panel.border = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_rect(fill = "grey100"))

sus_lake_dist

sus_lake_dist %>% ggsave(filename = "figs/sus_lake_dist_lightbg.png",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")

sus_lake_dist %>% ggsave(filename = "figs/sus_lake_dist_lightbg.pdf",
                       width = 7.5,
                       height = 4.5,
                       dpi = "retina")
```

```{r}

## summer mean temp and lake color

load("outputs/grid_color_stats_sf.RData", verbose = T)

## grid scale median lake color vs color spatial variability

color_std_scatter = grid_color_mode %>% 
  ggplot(aes(x = median, y = sd)) +
  geom_point(aes(size = n, color = median), alpha = 0.8) +
  scale_color_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  # geom_smooth(alpha = 0.7, method = "loess") +
  labs(
    x = "Median modal color (nm)",
    y = "Spatial model color standard deviation (nm)",
    size = "No. of lakes"
  ) +
  theme_bw()

color_std_scatter

color_std_scatter %>% ggsave(filename = "figs/color_std_scatter.png",
                             width = 7,
                             height = 4)




## grid cell lake variability vs median color

color_std_scatter2 = grid_color_mode %>% 
  mutate(color_grp = cut(median, breaks = c(min(median), 526, max(median)), labels = c("Blue", "Non-blue"), include.lowest = T)) %>% 
  ggplot(aes(x = color_grp, y = sd)) +
  geom_violin(scale = "count", fill = "darkgrey") +
  # scale_color_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  # scale_x_log10() +
  # geom_smooth(alpha = 0.7, method = "loess") +
  labs(
    x = "",
    y = "Color variability (nm)"
    # color = "Median lake color (nm)"
  ) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")

color_std_scatter2

color_std_scatter2 %>% ggsave(filename = "figs/color_std2.png",
                             width = 4,
                             height = 4)

## latitudinal color pattern

modelInput %>% names()
modelInput %>% dplyr::select(lat) %>% summary()

lat_std = modelInput %>% 
  mutate(latGrp = base::cut(lat, breaks = seq(-54, 78, by = 3), include.lowest = T, ordered_results = T)) %>% 
  group_by(latGrp) %>% 
  summarise(
    median_color = median(mode),
    n_lakes = n(),
    color_std = sd(mode)
  ) %>% ungroup() %>% 
  ggplot(aes(x = color_std, y = latGrp)) +
  geom_point(aes(size = n_lakes), alpha = 0.7) +
  scale_color_gradientn(limits = c(472, 588), colours = dw2FUI(472:588), na.value='#FFFFFF00') +
  labs(x = "Color variability (nm)",
       y = "Latitudinal groups (º)",
       size = "No. of lakes") +
  theme_bw()

lat_std

lat_std %>% ggsave(filename = "figs/lat_std_deep_lakes.png",
                   width = 5,
                   height = 8)
```